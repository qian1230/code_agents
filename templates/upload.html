{% extends "base.html" %}
{% block content %}
    <div class="card">
        <div class="card-body">
            <h2 class="card-title">ä¸Šä¼ ä»£ç æ–‡ä»¶</h2>
            <p class="card-text">ä¸Šä¼ å•ä¸ªä»£ç æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œæ”¯æŒ Python ç­‰å¸¸è§ç¼–ç¨‹è¯­è¨€ã€‚</p>
            
            <form id="upload-form" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="file" class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                    <input type="file" class="form-control" id="file" name="file" required>
                </div>
                <button type="submit" class="btn btn-primary">ä¸Šä¼ å¹¶åˆ†æ</button>
            </form>
            
            <div id="realtime-output" class="mt-4 p-3 bg-light rounded border" style="white-space: pre-wrap; word-wrap: break-word; max-height: 320px; overflow-y: auto;">
    <h4>å®æ—¶è¾“å‡º</h4>
    <div id="output-content" class="mt-2">
        <p>é€‰æ‹©æ–‡ä»¶å¹¶ç‚¹å‡»ä¸Šä¼ æŒ‰é’®å¼€å§‹åˆ†æ...</p>
    </div>
</div>
            
            <div id="result" class="mt-4 d-none">
                <div class="card">
                    <div class="card-header">
                        <h4>åˆ†æç»“æœ</h4>
                    </div>
                    <div class="card-body">
                        <div id="result-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('result-content');
            const outputContent = document.getElementById('output-content');
            
            // æ˜¾ç¤ºå®æ—¶è¾“å‡º
            outputContent.innerHTML = '<p>æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</p>';
            
            resultContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">åˆ†æä¸­...</span></div><p class="mt-2">æ­£åœ¨åˆ†æä»£ç ï¼Œè¯·ç¨å€™...</p></div>';
            resultDiv.classList.remove('d-none');
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    outputContent.innerHTML += '<p>âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼</p>';
                    outputContent.innerHTML += '<p>ğŸ“Š åˆ†æå®Œæˆï¼</p>';
                    resultContent.innerHTML = `
                        <p class="text-success">âœ… æ–‡ä»¶ <strong>${data.filename}</strong> å·²æˆåŠŸä¸Šä¼ å¹¶åˆ†æ</p>
                        <div class="result-block">
                            ${data.response.replace(/\n/g, '<br>')}
                        </div>
                    `;
                } else {
                    outputContent.innerHTML += `<p class="text-danger">âŒ ${data.message}</p>`;
                    resultContent.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            })
            .catch(error => {
                outputContent.innerHTML += `<p class="text-danger">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</p>`;
                resultContent.innerHTML = `<div class="alert alert-danger">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
            });
        });
    </script>
{% endblock %}
